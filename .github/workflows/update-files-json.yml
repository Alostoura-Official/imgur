name: Generate files.json with image dates

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run Python script
        run: |
          python <<EOF
          import os
          import json
          from datetime import datetime

          allowed_exts = ('.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp')
          files = []

          for root, dirs, filenames in os.walk('.'):
              for f in filenames:
                  if f.lower().endswith(allowed_exts):
                      full_path = os.path.join(root, f)
                      if os.path.isfile(full_path):
                          rel_path = os.path.relpath(full_path, '.')
                          mtime = os.path.getmtime(full_path)
                          formatted_date = datetime.fromtimestamp(mtime).strftime("%Y-%m-%d(%p %I:%M:%S)")
                          files.append({
                              "name": rel_path,
                              "date": formatted_date
                          })

          files.sort(key=lambda x: x["date"], reverse=True)

          with open('files.json', 'w', encoding='utf-8') as f:
              json.dump(files, f, indent=2, ensure_ascii=False)
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Update files.json with image metadata"
          branch: main
          file_pattern: files.json
